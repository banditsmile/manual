<!DOCTYPE html>
    <!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
    <!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
         <title>Using Durability and Recovery</title> 
        <link rel="shortcut icon" href="../../../static_star_theme/img/favicon.ico"/>
        <link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="../../../static_star_theme/css/theme.css" type="text/css" /> 
        <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>
    </head>

    <body class="wy-body-for-nav" role="document">

    <div class="wy-grid-for-nav">

        <div class="wy-full-navbar" data-swiftype-index="false">
            <a href="http://www.memsql.com" class="logo">
                <img src="../../../static_star_theme/img/memsql_logo_horizontal_white.svg" />
            </a>
            <div class="global nav">
                <div class="pull-left left-links">
                </div>
                <div class="pull-right right-links">
                    <a href="http://www.memsql.com/community/" style="word-spacing: 2px;">Community Edition</a>
                    <a href="http://blog.memsql.com">Blog</a>
                    <a href="http://www.memsql.com/memsql-partners">Partners</a>
                    <a href="http://www.memsql.com/resources">Resources</a>
                    <a href="../../../index.html">Documentation</a>
                    <a href="http://www.memsql.com/contact">Contact</a>
                </div>
            </div>
            <div class="nav-links">
                <a href="http://www.memsql.com/product">Product</a>
                <a href="http://www.memsql.com/solutions">Solutions</a>
                <a href="http://www.memsql.com/case-studies">Case Studies</a>
                <a href="http://www.memsql.com/company">Company</a>
                <a class="download" href="http://www.memsql.com/download/">Download Now</a>
            </div>
        </div>

        <nav data-toggle="wy-nav-shift" class="wy-nav-side" data-swiftype-index="false">
            <div class="wy-side-nav-search">
                <div role="search">
  <form id="search-form" class="wy-form" method="get">
    <input type="text" id="st-search-input" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
            </div>

            <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                
                 <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">MemSQL Docs Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">How MemSQL Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup/quick_start/index.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../setup/get_started/index.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../concepts/index.html">User Manual</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Operations Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../upgrade/index.html">Upgrading MemSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../admin_concepts/index.html">Administrator Key Concepts</a></li>
<li class="toctree-l2"><a class="reference internal" href="../cluster/index.html">Administering a Cluster</a></li>
<li class="toctree-l2"><a class="reference internal" href="../security/index.html">Securing MemSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ssl/index.html">SSL Network Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="../high_availability/index.html">Managing High Availability</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="index.html">Using Durability and Recovery</a><ul>
<li class="toctree-l3"><a class="reference internal" href="index.html#id1">Durability</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#recovering-data">Recovering Data</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../replication/index.html">Using Replication</a></li>
<li class="toctree-l2"><a class="reference internal" href="../backup_restore/index.html">Backing Up and Restoring Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../data_export/index.html">Exporting Data From MemSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tracelog/index.html">Trace Log</a></li>
<li class="toctree-l2"><a class="reference internal" href="../from_mysql/index.html">Transitioning from MySQL to MemSQL</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../ref/commands_by_type/index.html">SQL Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config/index.html">Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ops/index.html">MemSQL Ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../loader/index.html">MemSQL Loader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../archive/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../editions/index.html">MemSQL Editions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Frequently Asked Questions</a></li>
</ul>
 
            </div>
            &nbsp;
        </nav>

        <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
            <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
                <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
                <a href="../../../index.html" class="logo">
                    <img src="../../../static_star_theme/img/memsql_logo_horizontal_white.svg" />
                    <span class="subtitle">Documentation</span>
                </a>
            </nav>

            <div class="wy-nav-content">
                <div class="rst-content">
                    <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">MemSQL Documentation</a> &raquo;</li>
      
          <li><a href="../index.html">Operations Manual</a> &raquo;</li>
      
    <li>Using Durability and Recovery</li>
      <li class="wy-breadcrumbs-aside">
        
      </li>
  </ul>
  <hr/>
</div>
                    <div role="main" class="document">
                        
  <div class="section" id="using-durability-and-recovery">
<span id="durability"></span><h1>Using Durability and Recovery<a class="headerlink" href="index.html#using-durability-and-recovery" title="Permalink to this headline">¶</a></h1>
<p>Although MemSQL&#8217;s primary storage is main memory, the server maintains a copy of the data on disk as well.</p>
<div class="section" id="id1">
<h2>Durability<a class="headerlink" href="index.html#id1" title="Permalink to this headline">¶</a></h2>
<p>By default, MemSQL runs with full durability enabled. Transactions are committed to disk as a log and later compressed into full-database snapshots.</p>
<p>The snapshot and log files are stored in the <tt class="docutils literal"><span class="pre">datadir</span></tt> directory configured in <a class="reference internal" href="../memsql.cnf/index.html"><em>memsql.cnf</em></a>. When MemSQL is restarted, it will recover itself into the state it was in before the shutdown, by reading the snapshot and log files in <tt class="docutils literal"><span class="pre">datadir</span></tt>.
The snapshot and log files are stored in the <tt class="docutils literal"><span class="pre">datadir</span></tt> directory configured in <a class="reference internal" href="../memsql.cnf/index.html"><em>memsql.cnf</em></a>. When MemSQL is restarted, it will recover itself into the state it was in before the shutdown, by reading the snapshot and log files in <tt class="docutils literal"><span class="pre">datadir</span></tt>.</p>
<div class="section" id="configuring-durability">
<span id="durability-configuration"></span><h3>Configuring Durability<a class="headerlink" href="index.html#configuring-durability" title="Permalink to this headline">¶</a></h3>
<p>The <tt class="docutils literal"><span class="pre">transaction-buffer</span></tt> setting allows you to configure the maximum size of the in-memory, per-database buffer of database transactions. If this buffer
fills up, write queries will block until some of it is committed to disk to make space for new transactions. This buffer also limits the size of any individual
log record. In practice, the size of this log limits the size of an individual row (based on the serialized size of the row).</p>
<p>If <tt class="docutils literal"><span class="pre">transaction-buffer</span></tt> is set to 0, the database runs with disk-synchronous durability: every write transaction is committed to disk before the
query is acknowledged.</p>
<p>You can audit the performance of the log by monitoring the <tt class="docutils literal"><span class="pre">Transaction_buffer_wait_time</span></tt> variable in <tt class="docutils literal"><span class="pre">show</span> <span class="pre">status</span></tt>. If you notice that
this value is growing over time, then the hard disk is unable to keep up with the pace of write queries committed in-memory. To fix this,
you can</p>
<blockquote>
<div><ul class="simple">
<li>Restart the server with a larger <tt class="docutils literal"><span class="pre">transaction-buffer</span></tt>. This will increase the size of the in-memory transaction buffer, effectively allowing more
room for transactions to sit and wait while the hard drive catches up. The trade off is that the upper bound of data the server can lose in the event
of an unexpected system failure is now greater, because more transactions can live in memory and not yet on disk.</li>
<li>Reconfigure the server to use a faster disk. MemSQL exclusively relies on sequential (not random) disk writes, so using an SSD will dramatically
improve durability write performance.</li>
</ul>
</div></blockquote>
<p>When the log reaches <tt class="docutils literal"><span class="pre">snapshot-trigger-size</span></tt>, the database kicks off a new snapshot, which is a full backup of the database.</p>
<p>The last <tt class="docutils literal"><span class="pre">snapshots-to-keep</span></tt> snapshot and log files are kept by MemSQL in the data directory.  Old files are automatically deleted after they have
rotated out of the <tt class="docutils literal"><span class="pre">snapshots-to-keep</span></tt> window.  MemSQL waits for the current snapshot to be completely written to disk before
deleting older snapshots. This means enough disk space for <tt class="docutils literal"><span class="pre">snapshots-to-keep</span></tt> + 1 snapshots is needed to run MemSQL (+1 for the
snapshot currently being written).  By default <tt class="docutils literal"><span class="pre">snapshots-to-keep</span></tt> is set to 2.</p>
<p>Currently, durability is enabled or disabled for the entire MemSQL database server instance.
Durability cannot be selectively enabled or disabled by database.</p>
</div>
<div class="section" id="disabling-durability">
<h3>Disabling Durability<a class="headerlink" href="index.html#disabling-durability" title="Permalink to this headline">¶</a></h3>
<p>It is not possible to disable durability on a MemSQL cluster.  MemSQL relies on durabilitly to replicate data across the cluster.</p>
</div>
<div class="section" id="snapshot-and-log-file-formats">
<h3>Snapshot and Log File Formats<a class="headerlink" href="index.html#snapshot-and-log-file-formats" title="Permalink to this headline">¶</a></h3>
<p>MemSQL&#8217;s snapshots and logs use an internal binary format. Because MemSQL reconstructs indexes while recovering or replicating data, these files only store row data, not indexes. Database snapshots
are generally smaller than their corresponding in-memory footprint because they do not store indexes.
Both snapshots and log files contain checksums to confirm data integrity. The checksums are computed with the <tt class="docutils literal"><span class="pre">CRC32</span></tt> instruction.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>If you see the following warning message</p>
<blockquote>
<div><cite>Warning: SSE4.2 is not supported. Resorting to software CRC32C. MemSQL recovery and log writing performance will be negatively impacted.</cite></div></blockquote>
<p class="last">your system does not support the CRC32 instruction (part of Intel&#8217;s SSE4.2 instruction set). This is common on older processors and some virtualized environments. MemSQL can use a software implementation of CRC32;
however, this will slow down reading and writing log files in MemSQL. We recommend that production deployments of MemSQL run on environments that support this instruction. You can validate
whether a host supports this instruction set by running the <tt class="docutils literal"><span class="pre">check_system</span></tt> script packaged with MemSQL.</p>
</div>
</div>
</div>
<div class="section" id="recovering-data">
<h2>Recovering Data<a class="headerlink" href="index.html#recovering-data" title="Permalink to this headline">¶</a></h2>
<p>When MemSQL starts, it asynchronously loads data into memory from snapshots and logs. A database that is in this loading state is referred to as <tt class="docutils literal"><span class="pre">recovering</span></tt>. Connections to a database that is recovering are not allowed.</p>
<div class="section" id="recovery-status">
<h3>Recovery Status<a class="headerlink" href="index.html#recovery-status" title="Permalink to this headline">¶</a></h3>
<p>Run <a class="reference internal" href="../../ref/SHOW_DATABASES/index.html"><em>SHOW DATABASES</em></a> with the <tt class="docutils literal"><span class="pre">EXTENDED</span></tt> option to see which databases are recovering and to get an estimate for how long recovery will take. For more information, see <a class="reference internal" href="../../concepts/database/index.html#database-states"><em>Database States</em></a>.</p>
</div>
<div class="section" id="recovery-errors">
<h3>Recovery Errors<a class="headerlink" href="index.html#recovery-errors" title="Permalink to this headline">¶</a></h3>
<p>MemSQL uses checksums in both the snapshot and log files to confirm data integrity.  Snapshot and log recovery behave differently if an inconsistency between the data and a checksum is detected. If while recovering
from a log file, MemSQL discovers an inconsistency between the data and a checksum, the database enters the <tt class="docutils literal"><span class="pre">offline</span></tt> state (see <a class="reference internal" href="../../concepts/database/index.html#database-states"><em>Database States</em></a>).
No connections to the database are allowed when it&#8217;s in the <tt class="docutils literal"><span class="pre">offline</span></tt> state. To bring the database into the <tt class="docutils literal"><span class="pre">online</span></tt> state, run <a class="reference internal" href="../../ref/REPAIR_DATABASE/index.html"><em>REPAIR DATABASE</em></a>.  This command first creates a copy of the log and then repairs the
log corruption by truncating the log and loading as much data from the log as possible into memory. <a class="reference internal" href="../../ref/REPAIR_DATABASE/index.html"><em>REPAIR DATABASE</em></a> will not try to reconstruct the corrupted data. MemSQL log checksums can only detect, not repair, corruptions. Any data after the corruption in the log won&#8217;t be recovered as MemSQL can&#8217;t guarantee the consistency of this data.
If a corrupted log record manipulates the same data as a later log record, replaying the log past the corruption can result in wrong results. If MemSQL discovers an inconsistency between the data and a checksum while replaying the snapshot the database enters the <tt class="docutils literal"><span class="pre">unrecoverable</span></tt> state.  There is no way to repair a database in the <tt class="docutils literal"><span class="pre">unrecoverable</span></tt> state.  The database must be recovered from a backup using <a class="reference internal" href="../../ref/RESTORE/index.html"><em>RESTORE</em></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Any data in the log that occurs after the log corruption will be removed after <a class="reference internal" href="../../ref/REPAIR_DATABASE/index.html"><em>REPAIR DATABASE</em></a> has executed. <a class="reference internal" href="../../ref/REPAIR_DATABASE/index.html"><em>REPAIR DATABASE</em></a> will make a copy of the corrupted log before truncating it.</p>
</div>
<p><strong>Related Topics</strong></p>
<ul class="simple">
<li><a class="reference internal" href="../index.html"><em>Operations Manual</em></a></li>
<li><a class="reference internal" href="../../ref/BACKUP/index.html"><em>BACKUP</em></a></li>
<li><a class="reference internal" href="../../ref/RESTORE/index.html"><em>RESTORE</em></a></li>
<li><a class="reference internal" href="../../ref/SNAPSHOT_DATABASE/index.html"><em>SNAPSHOT DATABASE</em></a></li>
</ul>
</div>
</div>
</div>


                    </div>
                    <footer data-swiftype-index="false">
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../replication/index.html" class="btn btn-neutral float-right" title="Using Replication">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../high_availability/index.html" class="btn btn-neutral" title="Managing High Availability"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>&copy; Copyright 2015, MemSQL</p>
  </div>
</footer>
                </div>
            </div>

        </section>
    </div>

    <script type="text/javascript" src="../../../static_star_theme/js/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../../../static_star_theme/js/underscore-min.js"></script>
    <script type="text/javascript" src="../../../static_star_theme/js/jquery.ba-hashchange.min.js"></script>
    <script type="text/javascript" src="../../../static_star_theme/js/jquery.swiftype.search.js"></script>
    <script type="text/javascript" src="../../../static_star_theme/js/jquery.swiftype.autocomplete.js"></script>
    <script type="text/javascript" src="../../../static_star_theme/js/theme.js"></script>
    <script type="text/javascript" src="../../../static_star_theme/js/search.js"></script> 

        <!-- Google Analytics -->
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-21693588-3', 'auto');
            ga('send', 'pageview');
        </script>
        <!-- End Google Analytics -->

        <script type="text/javascript">
            $.ajax({
                url: document.location.protocol + '//munchkin.marketo.net/munchkin.js',
                dataType: 'script',
                cache: true,
                success: function() {
                    Munchkin.init('759-YLI-316');
                }
            });
        </script>
    </body>
</html>